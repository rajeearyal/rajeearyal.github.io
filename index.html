<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rajee Aryal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Alegreya+Sans+SC:wght@400;500;700&family=Cormorant+SC:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="weavingContainer">
      <div id="centerMask">
        <div id="topMeta">
          <span id="artistName">RAJEE ARYAL</span>
          <a id="emailLink" href="mailto:rajeearyal@gmail.com"
            >rajeearyal@gmail.com</a
          >
          <a href="artist-bio.html" target="_blank" rel="noopener">
            Artist Bio
          </a>
        </div>
        <div id="galleryRoot"></div>
      </div>
    </div>
    <script>
      const galleryRoot = document.getElementById("galleryRoot");
      const topMeta = document.getElementById("topMeta");
      const categories = [
        {
          label: "Works on Organza & Canvas",
          folder: "WorksOnOrganza&Canvas",
          fallback: ["1.jpg", "2.jpg", "3.jpg", "4.jpg"],
          metaFile: "artworks.json",
        },
        {
          label: "Works on Paper",
          folder: "WorksOnPaper",
          fallback: ["1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg"],
          metaFile: "artworks.json",
        },
        {
          label: "Works on Organza & Paper",
          folder: "WorksOnOrganza&Paper",
          fallback: ["1.jpg", "2.jpg", "3.jpg", "4.jpg", "5.jpg", "6.jpg"],
          metaFile: "artworks.json",
        },
        {
          label: "Handstitching on Lokta Paper",
          folder: "HandstichingOnLoktaPaper",
          fallback: ["1.jpeg", "2.jpg", "3.jpg", "5.jpg", "6.jpg"],
        },
        {
          label: "Digital Weavings",
          folder: "DigitalWeavings",
          fallback: [
            "1.jpg",
            "2.png",
            "3.png",
            "4.png",
            "5.png",
            "6.png",
            "7.png",
            "8.jpg",
            "9.jpg",
          ],
        },
        {
          label: "Digital Calligrams (of sorts)",
          folder: "DigitalCalligrams",
          fallback: [
            "1.png",
            "4.jpg",
            "7.png",
            "8.png",
            "9.png",
            "10.png",
            "11.png",
            "13.png",
            "14.png",
          ],
        },
      ];

      const IMAGE_EXT = /\.(png|jpe?g|webp|gif|avif)$/i;

      function safeDecodeURIComponent(value) {
        try {
          return decodeURIComponent(value);
        } catch {
          return value;
        }
      }

      function encodePath(path) {
        return path
          .split("/")
          .map((part) => encodeURIComponent(part))
          .join("/");
      }

      function fileNameFromHref(href) {
        if (!href) return "";
        const cleanHref = href.split("#")[0].split("?")[0].trim();
        if (!cleanHref || cleanHref.endsWith("/")) return "";
        const normalized = cleanHref.replace(/\\/g, "/");
        const parts = normalized.split("/").filter(Boolean);
        return safeDecodeURIComponent(parts[parts.length - 1] || "");
      }

      async function getImagesForFolder(folder, fallbackFiles) {
        try {
          const response = await fetch(`${encodePath(folder)}/`);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const html = await response.text();
          const doc = new DOMParser().parseFromString(html, "text/html");
          const uniqueFiles = new Set();
          [...doc.querySelectorAll("a")].forEach((a) => {
            const file = fileNameFromHref(a.getAttribute("href") || "");
            if (file && IMAGE_EXT.test(file)) uniqueFiles.add(file);
          });

          const files = [...uniqueFiles]
            .sort((a, b) =>
              a.localeCompare(b, undefined, {
                numeric: true,
                sensitivity: "base",
              }),
            )
            .map((file) => `${encodePath(folder)}/${encodeURI(file)}`);
          if (files.length) return files;
        } catch (_) {
          // Fallback for environments without directory listing.
        }
        return fallbackFiles.map(
          (f) => `${encodePath(folder)}/${encodeURI(f)}`,
        );
      }

      async function initCarousel() {
        const [categoryImages, categoryMeta] = await Promise.all([
          Promise.all(
            categories.map((c) => getImagesForFolder(c.folder, c.fallback)),
          ),
          Promise.all(
            categories.map((c) => {
              if (!c.metaFile) return Promise.resolve(null);
              const metaUrl = `${encodePath(c.folder)}/${encodeURIComponent(c.metaFile)}`;
              return fetch(metaUrl)
                .then((r) => (r.ok ? r.json() : null))
                .catch(() => null);
            }),
          ),
        ]);

        const lightbox = document.createElement("div");
        lightbox.id = "lightbox";
        lightbox.setAttribute("aria-hidden", "true");
        lightbox.hidden = true;

        const lightboxImg = document.createElement("img");
        lightboxImg.id = "lightboxImg";
        lightboxImg.alt = "";

        const lightboxClose = document.createElement("button");
        lightboxClose.id = "lightboxClose";
        lightboxClose.type = "button";
        lightboxClose.textContent = "Close";

        lightbox.appendChild(lightboxClose);
        lightbox.appendChild(lightboxImg);
        document.body.appendChild(lightbox);

        const gallery = document.createElement("section");
        gallery.className = "gallery-layout";

        const carousel = document.createElement("div");
        carousel.className = "carousel-frame";

        const stage = document.createElement("div");
        stage.className = "carousel-stage";

        const media = document.createElement("div");
        media.className = "carousel-media";

        const image = document.createElement("img");
        image.className = "carousel-image";
        image.alt = "";

        const meta = document.createElement("div");
        meta.className = "carousel-meta";
        meta.hidden = true;

        const dots = document.createElement("div");
        dots.className = "carousel-dots";

        const links = document.createElement("div");
        links.className = "carousel-links";

        const mobileCategoryNav = document.createElement("div");
        mobileCategoryNav.className = "mobile-category-nav";

        const mobilePrev = document.createElement("button");
        mobilePrev.type = "button";
        mobilePrev.className = "mobile-category-btn";
        mobilePrev.setAttribute("aria-label", "Previous category");
        mobilePrev.textContent = "‹";

        const mobileCategoryLabel = document.createElement("div");
        mobileCategoryLabel.className = "mobile-category-label";

        const mobileNext = document.createElement("button");
        mobileNext.type = "button";
        mobileNext.className = "mobile-category-btn";
        mobileNext.setAttribute("aria-label", "Next category");
        mobileNext.textContent = "›";

        mobileCategoryNav.appendChild(mobilePrev);
        mobileCategoryNav.appendChild(mobileCategoryLabel);
        mobileCategoryNav.appendChild(mobileNext);

        const categoryLinkEls = [];
        let activeCategory = 0;
        let activeImage = 0;
        let activeImageUrl = "";
        let suppressImageClickUntil = 0;
        let touchStartX = 0;
        let touchStartY = 0;

        function basename(path) {
          return String(path).split("/").pop() || "";
        }

        function getFirstValue(record, keys) {
          if (!record) return "";
          for (const key of keys) {
            if (record[key] !== undefined && record[key] !== null) {
              const value = String(record[key]).trim();
              if (value) return value;
            }
          }
          return "";
        }

        function normalizeMeta(record) {
          if (!record) return null;
          return {
            title: getFirstValue(record, ["title", "Title"]),
            description: getFirstValue(record, [
              "description",
              "Description",
              "media",
              "Media",
            ]),
            size: getFirstValue(record, [
              "size",
              "Size",
              "dimensions",
              "Dimensions",
            ]),
            year: getFirstValue(record, ["year", "Year"]),
          };
        }

        function getMetaForActiveImage() {
          const map = categoryMeta[activeCategory];
          if (!map || !activeImageUrl) return null;
          const key = decodeURIComponent(basename(activeImageUrl));
          const stem = key.replace(/\.[^.]+$/, "");
          const candidates = [
            key,
            encodeURIComponent(key),
            stem,
            `${stem}.jpg`,
            `${stem}.jpeg`,
            `${stem}.png`,
            `${stem}.webp`,
            `${stem}.JPG`,
            `${stem}.JPEG`,
            `${stem}.PNG`,
            `${stem}.WEBP`,
          ];
          for (const candidate of candidates) {
            if (map[candidate]) return normalizeMeta(map[candidate]);
          }
          return null;
        }

        function closeLightbox() {
          lightbox.hidden = true;
          lightbox.setAttribute("aria-hidden", "true");
          lightboxImg.removeAttribute("src");
        }

        function openLightbox() {
          if (!activeImageUrl) return;
          lightboxImg.src = activeImageUrl;
          lightbox.hidden = false;
          lightbox.setAttribute("aria-hidden", "false");
        }

        lightboxClose.addEventListener("click", closeLightbox);
        lightbox.addEventListener("click", (event) => {
          if (event.target === lightbox) closeLightbox();
        });
        window.addEventListener("keydown", (event) => {
          if (event.key === "Escape") closeLightbox();
        });

        function shiftImage(direction) {
          const images = categoryImages[activeCategory] || [];
          if (images.length < 2) return;
          activeImage =
            (activeImage + direction + images.length) % images.length;
          render();
        }

        image.addEventListener("click", () => {
          if (Date.now() < suppressImageClickUntil) return;
          openLightbox();
        });
        image.addEventListener(
          "touchstart",
          (event) => {
            const touch = event.changedTouches && event.changedTouches[0];
            if (!touch) return;
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
          },
          { passive: true },
        );
        image.addEventListener(
          "touchend",
          (event) => {
            const touch = event.changedTouches && event.changedTouches[0];
            if (!touch) return;
            const deltaX = touch.clientX - touchStartX;
            const deltaY = touch.clientY - touchStartY;
            const minSwipe = 34;
            const maxVerticalDrift = 56;
            if (
              Math.abs(deltaX) >= minSwipe &&
              Math.abs(deltaY) <= maxVerticalDrift
            ) {
              shiftImage(deltaX < 0 ? 1 : -1);
              suppressImageClickUntil = Date.now() + 350;
            }
          },
          { passive: true },
        );
        function syncTextWidths() {
          const width = Math.max(
            0,
            Math.round(image.getBoundingClientRect().width),
          );
          const value = width ? `${width}px` : "";
          meta.style.width = value;
          if (topMeta) topMeta.style.width = value;
          if (topMeta) {
            const isNarrow = window.matchMedia("(max-width: 980px)").matches;
            links.style.marginTop = isNarrow
              ? "0px"
              : `${topMeta.offsetHeight + 8}px`;
          }
        }
        image.addEventListener("load", syncTextWidths);
        window.addEventListener("resize", syncTextWidths);

        function render() {
          const images = categoryImages[activeCategory] || [];
          activeImage = Math.min(activeImage, Math.max(images.length - 1, 0));

          if (images.length) {
            activeImageUrl = images[activeImage];
            image.src = activeImageUrl;
          } else {
            activeImageUrl = "";
            image.removeAttribute("src");
          }

          const info = getMetaForActiveImage();
          if (info) {
            meta.hidden = false;
            const sizeLine = info.size
              ? `<div class="meta-size">${info.size}</div>`
              : "";
            meta.innerHTML = `
              <div class="meta-title">${info.title || ""}</div>
              <div class="meta-media">${info.description || ""}</div>
              ${sizeLine}
              <div class="meta-year">${info.year || ""}</div>
            `;
          } else {
            meta.hidden = true;
            meta.innerHTML = "";
          }
          syncTextWidths();

          dots.replaceChildren();
          images.forEach((_, i) => {
            const dot = document.createElement("button");
            dot.type = "button";
            dot.className = "carousel-dot";
            dot.classList.toggle("active", i === activeImage);
            dot.setAttribute("aria-label", `Show image ${i + 1}`);
            dot.addEventListener("click", () => {
              activeImage = i;
              render();
            });
            dots.appendChild(dot);
          });

          categoryLinkEls.forEach((el, i) =>
            el.classList.toggle("active", i === activeCategory),
          );
          mobileCategoryLabel.textContent = categories[activeCategory].label;
        }

        categories.forEach((category, i) => {
          const link = document.createElement("a");
          link.className = "tile-link carousel-link";
          link.href = "#";
          link.textContent = category.label;
          link.addEventListener("click", (event) => {
            event.preventDefault();
            activeCategory = i;
            activeImage = 0;
            render();
          });
          links.appendChild(link);
          categoryLinkEls.push(link);
        });

        function stepCategory(direction) {
          activeCategory =
            (activeCategory + direction + categories.length) %
            categories.length;
          activeImage = 0;
          render();
        }

        mobilePrev.addEventListener("click", () => {
          stepCategory(-1);
        });
        mobilePrev.addEventListener("touchend", (event) => {
          event.preventDefault();
          stepCategory(-1);
        });

        mobileNext.addEventListener("click", () => {
          stepCategory(1);
        });
        mobileNext.addEventListener("touchend", (event) => {
          event.preventDefault();
          stepCategory(1);
        });

        render();
        if (topMeta) carousel.appendChild(topMeta);
        carousel.appendChild(mobileCategoryNav);
        media.appendChild(image);
        stage.appendChild(media);
        carousel.appendChild(stage);
        carousel.appendChild(meta);
        carousel.appendChild(dots);
        gallery.appendChild(links);
        gallery.appendChild(carousel);
        galleryRoot.replaceChildren(gallery);
      }

      initCarousel();
    </script>
  </body>
</html>
